# CodeRabbit High-Level Summary Instructions
## SSF GraphQL Platform â€” Backend + Frontend PR Customization

> **Overview**: These instructions customize CodeRabbit's high-level summary generation to surface critical backend/frontend integration points, compliance impact, and infrastructure dependencies specific to the SSF GraphQL platform.

---

## ğŸ“‹ Summary Structure & Sections

Organize PR summaries into **six focused sections** with clear contributor context and deployment impact:

### 1. ğŸ“ **Executive Summary** (50â€“70 words)
Concisely describe *what changed* and *why*. For full-stack PRs, highlight both backend and frontend impacts.

**Example**:
- Backend only: "Updated UserService to cache query results via Redis, reducing database load by ~40%."
- Full-stack: "Implemented MFA TOTP enrollment in backend (new database schema) + corresponding Angular form UI."
- Breaking: "**BREAKING**: Renamed `getUserById` â†’ `getUser` in GraphQL schema; frontend Apollo codegen required."

**Usage**: One paragraph, audience-agnostic (explains what a non-technical stakeholder should know).

---

### 2. ğŸ”§ **Technology & Components Affected**
List **affected layers** with brief justification:

```
| Layer | Component | Change Type | Impact |
|-------|-----------|------------|--------|
| **Backend** | `SecurityConfig.java` | Auth filter logic | JWT validation now enforces XYZ |
| **Backend** | `schema.graphqls` | Schema breaking change | `UserQuery.login` â†’ `AuthQuery.login` |
| **Database** | `V###_migration.sql` | New table `mfa_totp_secrets` | Flyway runs on startup |
| **Frontend** | `login.component.ts` | New form field | MFA input field added |
| **Frontend** | `generated.ts` (Apollo codegen) | GraphQL types | Auto-regenerated; review for breaking types |
| **Observability** | Metrics exports | New metric `auth.mfa.failures` | Grafana dashboards updated |
```

**Guidance**:
- Include schema changes (always reviewable in PR diff).
- Flag migrations and breaking GraphQL changes prominently.
- Note Observable/Resilience4j updates if new metrics/circuit breakers are added.

---

### 3. ğŸ“¦ **Dependencies & Configuration Changes**

#### New/Updated Dependencies
```
- `org.springframework.boot:spring-boot-starter-*`: Updated to 3.5.7 â†’ 3.6.0
- `io.github.resilience4j:*`: 2.1.0 (no change; baseline)
- `io.projectreactor.netty:*`: 1.1.8 (pinned by Spring Boot 3.5.7)
- Frontend: `@angular/*`: 18.x (regenerate Apollo codegen if schema changes)
```

#### Environment Variables Added / Modified
| Variable | Type | Default | Note |
|----------|------|---------|------|
| `MFA_TOTP_ISSUER` | String | `SSF` | Configurable per deployment |
| `JWT_EXPIRATION` | Duration | `86400000` ms (1 day) | Sensitive: audit in compliance logs |
| `AUDIT_RETENTION_DAYS` | Integer | `90` | Data protection requirement (GDPR) |

#### Configuration Overrides
- If profile-specific (e.g., `application-prod.yml`), note differences.
- Highlight any new Spring properties requiring explicit setup.

#### Database Migrations
- List flyway migrations in order: `V###__description.sql`
- Note if migrations are **backward-incompatible** (e.g., column drops, index changes).
- Example: `V306__fix_audit_dynamic_crud_identity.sql` â€” requires audit table rebuild (low risk in dev, QA-test in staging).

---

### 4. ğŸ” **Security & Compliance Impact**

#### Authentication & Authorization
- JWT changes: expiration, claims, validation logic?
- New `GraphQLAuthorizationInstrumentation` rules?
- RBAC additions (e.g., new roles, field-level restrictions)?

**Example**:
```
âœ… **Auth Flow Unchanged** â€” JwtAuthenticationFilter â†’ SecurityConfig â†’ GraphQLAuthorizationInstrumentation chain remains.
ğŸ†• **MFA Enrollment** â€” Users can now enroll TOTP + SMS devices; JWT still validates identically.
âš ï¸ **Breaking**: `me()` query now requires `ROLE_USER`; previously public. Update frontend AuthGuard.
```

#### Data Protection
- New personally identifiable information (PII) fields?
- Encryption at rest / in transit changes?
- Audit logging added for sensitive operations?

**Example**:
```
ğŸ“‹ **Audit Logging** â€” Logins, role changes, and MFA operations logged to `AUDIT_SESSIONS` table (Phase 1).
ğŸ”’ **No PII in Logs** â€” Password attempts, secret keys, mfa backup codes not logged.
ğŸ“… **Retention** â€” 90 days via `AUDIT_RETENTION_DAYS` (GDPR compliance).
```

#### Known Vulnerabilities (CVEs)
- Any dependency upgrades that close vulnerabilities?
- Document with CVE ID and severity.

---

### 5. ğŸ§ª **Test Coverage & Quality Assurance**

#### Test Categories
| Category | Count | Status | Notes |
|----------|-------|--------|-------|
| **Unit (Spring Boot)** | 12 new | âœ… PASS | `@GraphQlTest` slices for resolver logic |
| **Integration (Testcontainers)** | 3 new | âœ… PASS | Oracle/Redis containers for MFA flows |
| **Frontend (Angular/Jasmine)** | 5 new | âœ… PASS | `login.component.spec.ts`, form validation |
| **E2E (Postman/Gatling)** | Updated | âš ï¸ Manual | Import latest `SSF-GraphQL-Postman-Collection.json` |

#### Coverage
- Backend JaCoCo: `75%` minimum (enforced); current PR: **78%** âœ…
- Frontend: No enforced threshold; PR adds 6 new test files.

#### Performance Benchmarks
- Query P95 latency baseline: **200ms** (cached) / **500ms** (uncached)
- Mutation P95 latency baseline: **300ms**
- PR impact: **Â±10ms** acceptable; flag if **>Â±50ms**.

---

### 6. âœ”ï¸ **Pre-Deployment Checklist & Reviewer Notes**

#### Deployment Order
```
1. âœ… Code Review (this PR)
2. ğŸ—ï¸ Build: ./gradlew clean build
3. ğŸ§ª Test: ./gradlew test (JaCoCo â‰¥75%)
4. ğŸ“¦ Frontend Codegen: npm run codegen (if schema changed)
5. ğŸ—„ï¸ DB: Flyway runs on app startup (if migrations included)
6. ğŸš€ Deploy: docker-compose up OR azd up
7. ğŸ“Š Verify: Grafana dashboards + health checks
```

#### Required Sign-Offs
- [ ] **Backend Code Review** (GraphQL schema + services)
- [ ] **Frontend Code Review** (if components/forms changed)
- [ ] **Security Review** (if auth or compliance rules modified)
- [ ] **DBA Review** (if schema/migrations changed)
- [ ] **QA Sign-Off** (performance + E2E tests passed)

#### Manual Testing Scenarios
```
ğŸ”§ If auth changed:
  1. POST /api/auth/login â†’ verify JWT is valid
  2. Authenticated GraphQL query â†’ verify auth header accepted
  3. Expired JWT â†’ verify 401 returned

ğŸ”§ If schema changed:
  1. Frontend: npm run codegen â†’ no TypeScript errors
  2. Postman: Import latest collection â†’ all requests resolve

ğŸ”§ If database migration included:
  1. Backup production schema (staging first)
  2. Run Flyway validation: ./gradlew flywayInfo
  3. Rollback plan documented in PR description
```

#### Monitoring & Observability
- New metrics exported? Update `monitoring/prometheus/alerts.yml` + Grafana dashboards.
- Health check changed? Verify `spring.boot.actuator.health` endpoints respond correctly.
- Example: `auth.mfa.failures` metric should appear in Prometheus after deploy.

---

## ğŸ¯ PR-Specific Customizations

### Backend-Only Changes
- Focus: Services, resolvers, security, database.
- Skip: Frontend sections; highlight GraphQL schema breaking changes.

### Frontend-Only Changes
- Focus: Components, routing, forms, API integration.
- Skip: Backend sections; note if Apollo codegen is required.

### Full-Stack (Backend + Frontend)
- Emphasize **integration points**: schema â†’ generated types â†’ component bindings.
- Flag schema breaking changes early (requires frontend regen).
- Include both backend and frontend test coverage.

### Database Migrations
- Always include migration file names (V###__description.sql).
- Highlight rollback risk and DBA involvement required.
- Link to `sql/README.md` for context.

### Infrastructure / DevOps
- New environment variables â†’ documented in PR and `README.md`.
- Docker image changes â†’ updated in `Dockerfile` and `docker-compose.yml`.
- Kubernetes secrets / Azure resources â†’ documented with deployment steps.

---

## ğŸ“Š Markdown Formatting & Style Guide

### Emojis & Icons
Use sparingly for quick scanning:
- âœ… Passing tests / Ready to deploy
- âš ï¸ Warning / Requires attention
- ğŸ†• New feature / Addition
- ğŸ”§ Configuration / Setup required
- ğŸ—„ï¸ Database change
- ğŸš€ Deployment / Release
- ğŸ“ Documentation
- ğŸ” Security-related
- ğŸ“Š Metrics / Observability

### Headings & Sections
- Use `#` (H1) only for PR title.
- Use `##` (H2) for main sections (above).
- Use `###` (H3) for subsections.
- Use `####` (H4) for deeply nested items.

### Tables
- Use Markdown tables for structured data (dependencies, coverage, layers).
- Keep columns concise (max 4â€“5 columns).
- Use left-align for text; right-align for metrics.

### Code Blocks
- Inline: `` `code` `` for file names, class names, variables.
- Multi-line: ` ``` ` fence with language hint (`graphql`, `sql`, `java`, `typescript`).
- Example: ` ```graphql \n query { } \n ``` `

### Links
- Link to relevant docs: `[MFA_IMPLEMENTATION.md](docs/MFA_IMPLEMENTATION.md)`
- Link to test files: `[login.component.spec.ts](frontend/src/app/features/auth/login.component.spec.ts)`
- Link to migrations: `[V306__fix_audit_dynamic_crud_identity.sql](db/migration/V306__fix_audit_dynamic_crud_identity.sql)`

---

## ğŸš€ Example: Complete PR Summary

### **MFA TOTP Enrollment Feature (Backend + Frontend)**

#### ğŸ“ Executive Summary
Added TOTP-based multi-factor authentication enrollment for users. Backend creates `MFA_TOTP_SECRETS` table, exposes GraphQL mutations for enrollment/verification, and stores TOTP secrets encrypted at rest. Frontend adds new MFA settings page with QR code scanner and recovery code display. No breaking changes to existing auth flow; MFA remains optional Phase 1.

#### ğŸ”§ Technology & Components Affected
| Layer | Component | Change Type | Impact |
|-------|-----------|------------|--------|
| **Backend** | `MfaService.java` | New service | Handles TOTP generation, validation, secret storage |
| **Backend** | `schema.graphqls` | New mutations | `enrollMfaTotp`, `verifyMfaTotp`, `listMfaDevices` |
| **Database** | `V300__mfa_totp_secrets.sql` | New table | Stores encrypted secrets; read-heavy, optimized for user_id lookup |
| **Database** | `indexes/mfa_totp_idx.sql` | New index | Composite index on (user_id, device_id) for fast device enumeration |
| **Frontend** | `mfa-settings.component.ts` | New component | Settings page with QR code display, device list, recovery code reveal |
| **Frontend** | `login.component.ts` | Updated | New optional TOTP input field (shown only if user enrolled) |
| **Frontend** | `generated.ts` | Apollo codegen | New types: `EnrollMfaTotpInput`, `VerifyMfaTotpInput`, `MfaDevice` |
| **Observability** | `auth.mfa.enrollments`, `auth.mfa.failures` | New metrics | Grafana: MFA adoption rate, failure rate trends |

#### ğŸ“¦ Dependencies & Configuration Changes
**New Dependencies**: None (TOTP lib already vendored in `spring-boot-starter-security`).

**Environment Variables**:
| Variable | Type | Default | Note |
|----------|------|---------|------|
| `MFA_TOTP_ISSUER` | String | `SSF` | Label in authenticator apps; customize per org |
| `MFA_TOTP_WINDOW` | Integer | `1` | Time window tolerance (Â±30s = 1 window) |

**Database Migrations**:
- `V300__mfa_totp_secrets.sql` â€” Creates table, sequences, triggers.
- `V301__mfa_sms_enrollments.sql` â€” SMS support (Phase 1b, deferred).

#### ğŸ” Security & Compliance Impact
âœ… **Auth Flow Unchanged** â€” Existing JWT â†’ GraphQL â†’ resolver chain remains; MFA checked **after** username/password validation.

ğŸ†• **MFA Secrets** â€” Stored encrypted in Oracle using `AES-256-GCM` (key from `JWT_SECRET`); no plaintext secrets ever logged.

ğŸ“‹ **Audit Logging** â€” MFA enrollment, verification success/failure logged to `AUDIT_LOGIN_ATTEMPTS` table with `event_type = 'mfa_totp_verify'`.

ğŸ”’ **No Shared Secrets** â€” Each device gets unique secret; recovery codes are one-time use.

#### ğŸ§ª Test Coverage & Quality Assurance
| Category | Count | Status | Notes |
|----------|-------|--------|-------|
| **Unit (Spring)** | 8 | âœ… PASS | `MfaServiceTests`, `MfaResolverTests` cover happy/sad paths |
| **Integration** | 2 | âœ… PASS | Oracle + Redis test containers verify secret encryption |
| **Frontend (Jasmine)** | 5 | âœ… PASS | Component initialization, QR code rendering, form submission |
| **E2E (Postman)** | Updated | â³ Manual | Import `SSF-GraphQL-Postman-Collection.json` v1.2+ |

**Coverage**:
- Backend JaCoCo: **79%** (â†‘4% from baseline 75%).
- Frontend: **6 new test files** covering MFA settings component + login integration.

#### âœ”ï¸ Pre-Deployment Checklist
```
1. âœ… Code Review (auth + encryption logic critical)
2. ğŸš€ Build: ./gradlew clean build â†’ JaCoCo â‰¥75%
3. ğŸ§ª Tests: ./gradlew test â†’ all pass
4. ğŸ“¦ Frontend: npm run codegen â†’ no TypeScript errors
5. ğŸ—„ï¸ DB: Flyway validates migrations; run on app startup
6. ğŸ“ Documentation: README.md updated with MFA setup instructions
7. ğŸ“Š Grafana: New MFA metrics appear in dashboards (wait ~5 min)
8. ğŸ” DBA Sign-Off: Migration reviewed for performance impact
```

**Rollback Plan**:
- Revert `V300__mfa_totp_secrets.sql` by restoring schema snapshot.
- Frontend: Remove MFA settings route from `app.routes.ts`.
- Environment: Unset `MFA_TOTP_ISSUER` variable.

---

## ğŸ“ Why This Structure Works

| Aspect | Benefit |
|--------|---------|
| **Executive Summary** | Non-technical stakeholders get instant context; developers understand scope |
| **Components Affected** | Reviewers see **exactly which files** need attention; catches integration issues |
| **Dependencies** | Operations + QA see environment setup; catch missing migrations early |
| **Security & Compliance** | Security/compliance teams get audit trails; audits pass first time |
| **Test Coverage** | QA knows what to manually test; coverage trends visible |
| **Pre-Deploy Checklist** | Ops + DBA follow repeatable deployment order; reduces post-deploy issues |

---

## ğŸ”„ Iterating on Summaries

1. **After first PR merge**: Collect feedback from code reviewers on clarity and completeness.
2. **Monthly**: Review 3â€“5 recent PR summaries; adjust sections if patterns emerge (e.g., missing security notes).
3. **Per release**: Update `Pre-Deployment Checklist` based on lessons learned.
4. **Annual**: Audit structure against project maturity (e.g., add load-testing section if performance becomes critical).

---

## ğŸ“š References
- [README.md](README.md) â€” Project overview, security roadmap.
- [docs/SECURITY_ARCHITECTURE.md](docs/SECURITY_ARCHITECTURE.md) â€” Auth + compliance details.
- [docs/MFA_IMPLEMENTATION.md](docs/MFA_IMPLEMENTATION.md) â€” MFA design + phase schedule.
- [frontend/.github/copilot-instructions.md](frontend/.github/copilot-instructions.md) â€” Frontend conventions.
- [.github/copilot-instructions.md](.github/copilot-instructions.md) â€” Backend conventions.

---

**Version**: 1.0 | **Last Updated**: November 2025 | **Applies to**: CodeRabbit Pro (beta)
