<div class="table-browser-container">
  <div class="header-section">
    <div class="header-left">
      <button nz-button nzType="default" (click)="goBack()">
        <span nz-icon nzType="arrow-left"></span>
        Back to Dashboard
      </button>
      <h2>Dynamic CRUD Interface</h2>
    </div>
  </div>

  <!-- Table Selection -->
  <div class="table-selection">
    <nz-select
      [(ngModel)]="selectedTable"
      (ngModelChange)="onTableSelect($event)"
      nzPlaceHolder="Select a table"
      nzAllowClear>
      <nz-option *ngFor="let table of availableTables" [nzValue]="table" [nzLabel]="table"></nz-option>
    </nz-select>
  </div>

  <!-- Table Actions -->
  <div class="table-actions" *ngIf="selectedTable">
    <div class="action-left">
      <div class="search-builder">
        <label class="section-label">Global search</label>
        <div class="global-search-row">
          <nz-input-group nzSearch [nzAddOnAfter]="searchButton">
            <input
              #searchInput
              type="text"
              nz-input
              [formControl]="globalSearchControl"
              placeholder="Search across columns"
              data-shortcut="search" />
          </nz-input-group>
          <button
            nz-button
            nzType="default"
            nzSize="small"
            type="button"
            (click)="clearGlobalSearch()"
            [disabled]="!searchValue && globalSearchColumns.length === 0">
            Clear
          </button>
        </div>
        <nz-select
          nzMode="multiple"
          nzAllowClear
          [ngModelOptions]="{ standalone: true }"
          [(ngModel)]="globalSearchColumns"
          nzPlaceHolder="Limit search to columns"
          nzMaxTagCount="3"
          (ngModelChange)="onGlobalSearchColumnsChange($event)">
          <nz-option *ngFor="let column of columns" [nzValue]="column.name" [nzLabel]="column.name"></nz-option>
        </nz-select>
        <ng-template #searchButton>
          <button nz-button nzType="primary" nzSearch (click)="onSearch()">
            <span nz-icon nzType="search"></span>
          </button>
        </ng-template>
      </div>

      <div class="filter-builder">
        <div class="filter-builder-header">
          <label class="section-label">Advanced filters</label>
          <div class="filter-operator-selector">
            <span>Combine with</span>
            <nz-select
              nzSize="small"
              [ngModelOptions]="{ standalone: true }"
              [(ngModel)]="filterGroupOperator"
              (ngModelChange)="onFilterGroupOperatorChange($event)">
              <nz-option nzValue="AND" nzLabel="AND"></nz-option>
              <nz-option nzValue="OR" nzLabel="OR"></nz-option>
            </nz-select>
          </div>
        </div>
        <form nz-form nzLayout="inline" [formGroup]="filterBuilderForm" class="filter-form" (ngSubmit)="addFilterChip()">
          <nz-form-item>
            <nz-form-control>
              <nz-select formControlName="column" nzPlaceHolder="Column" nzAllowClear>
                <nz-option *ngFor="let column of columns" [nzValue]="column.name" [nzLabel]="column.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-control>
              <nz-select formControlName="operator" nzPlaceHolder="Operator">
                <nz-option *ngFor="let option of operatorOptions" [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item class="value-field">
            <nz-form-control>
              <input nz-input type="text" formControlName="value" placeholder="Value" />
            </nz-form-control>
          </nz-form-item>
          <button nz-button nzType="dashed" type="submit">
            <span nz-icon nzType="plus"></span>
            Add
          </button>
        </form>

        <div class="filter-chips" *ngIf="filterChips.length > 0">
          <nz-tag
            *ngFor="let chip of filterChips"
            nzMode="closeable"
            (nzOnClose)="removeFilterChip(chip.id)">
            <span class="chip-column">{{ chip.column }}</span>
            <span class="chip-operator">{{ chip.operator }}</span>
            <span class="chip-value">{{ chip.value }}</span>
          </nz-tag>
          <button nz-button nzType="link" nzSize="small" type="button" (click)="clearFilterChips()">
            Clear filters
          </button>
        </div>
      </div>
    </div>

    <div class="action-right">
      <button nz-button nzType="primary" (click)="showCreateModal()">
        <span nz-icon nzType="plus"></span>
        Add Record
      </button>
      <button nz-button nzType="default" (click)="exportData()">
        <span nz-icon nzType="download"></span>
        Export CSV
      </button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-container" *ngIf="selectedTable">
    <nz-table
      #table
      [nzData]="tableData"
      [nzLoading]="loading"
      [nzFrontPagination]="false"
      [nzShowPagination]="false"
      [nzScroll]="{ x: '1000px' }">
      <thead>
        <tr>
          <th *ngFor="let column of columns"
              [nzSortFn]="false"
              [nzSortOrder]="column.name === sortField ? (sortOrder === 'ASC' ? 'ascend' : 'descend') : null"
              (nzSortOrderChange)="onColumnSort(column.name, $event)">
            {{ column.name | titlecase }}
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of tableData">
          <td *ngFor="let column of columns">
            {{ data[column.name] }}
          </td>
          <td>
            <button nz-button nzType="link" nzSize="small" (click)="showEditModal(data)">
              <span nz-icon nzType="edit"></span>
              Edit
            </button>
            <nz-popconfirm
              nzTitle="Are you sure you want to delete this record?"
              (nzOnConfirm)="handleDelete(data)">
              <button nz-button nzType="link" nzDanger nzSize="small">
                <span nz-icon nzType="delete"></span>
                Delete
              </button>
            </nz-popconfirm>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <!-- Pagination -->
    <div class="pagination-container">
      <nz-pagination
        [(nzPageIndex)]="currentPage"
        [(nzPageSize)]="pageSize"
        [nzTotal]="totalRecords"
        [nzShowSizeChanger]="true"
        [nzPageSizeOptions]="[10, 20, 50, 100]"
        (nzPageIndexChange)="onPageChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)">
      </nz-pagination>
    </div>
  </div>

  <!-- Shared CRUD Form Template -->
  <ng-template #crudForm>
    <nz-alert *ngIf="formColumnError" nzType="error" [nzMessage]="formColumnError" nzShowIcon nzCloseable></nz-alert>
    <form nz-form nzLayout="vertical">
      <app-dynamic-form-field
        *ngFor="let column of columns"
        [column]="column"
        [formGroup]="isEditModalVisible ? editFormGroup! : createFormGroup!">
      </app-dynamic-form-field>
    </form>
  </ng-template>

  <!-- Create Modal -->
  <nz-modal
    [(nzVisible)]="isCreateModalVisible"
    nzTitle="Create New Record"
    (nzOnCancel)="closeCreateModal()"
    (nzOnOk)="handleCreate()"
    [nzOkLoading]="loading">
    <ng-container *nzModalContent>
      <ng-container *ngTemplateOutlet="crudForm"></ng-container>
    </ng-container>
  </nz-modal>

  <!-- Edit Modal -->
  <nz-modal
    [(nzVisible)]="isEditModalVisible"
    nzTitle="Edit Record"
    (nzOnCancel)="closeEditModal()"
    (nzOnOk)="handleUpdate()"
    [nzOkLoading]="loading">
    <ng-container *nzModalContent>
      <ng-container *ngTemplateOutlet="crudForm"></ng-container>
    </ng-container>
  </nz-modal>
</div>